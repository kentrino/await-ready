name: Agent Review

on:
  pull_request:
    types: [review_requested, opened, reopened]
    branches: [main]
  issue_comment:
    types: [created]

jobs:
  gate:
    name: Wait for CI
    runs-on: ubuntu-latest
    # Triggers on pull requests except release-please and renovate branches,
    # or when a /review comment is posted
    if: |
      (
        (github.event_name == 'pull_request') ||
        (github.event_name == 'issue_comment' &&
         github.event.issue.pull_request &&
         contains(github.event.comment.body, '/review'))
      ) &&
      !(github.event_name == 'pull_request' && (
        startsWith(github.head_ref, 'release-please--') ||
        startsWith(github.head_ref, 'renovate/')
      ))
    permissions:
      contents: read
      checks: read
      pull-requests: read
      actions: read
    steps:
      - name: Verify commenter is a CODEOWNER
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENTER: ${{ github.event.comment.user.login }}
          REPO: ${{ github.repository }}
        run: |
          owners=$(gh api "repos/$REPO/contents/.github/CODEOWNERS" --jq '.content' | base64 -d | grep -o '@[^ ]*' | sed 's/@//')
          if ! echo "$owners" | grep -qx "$COMMENTER"; then
            echo "::error::$COMMENTER is not a CODEOWNER"
            exit 1
          fi

      - name: Wait for CI to pass
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          HEAD_SHA=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRefOid --jq '.headRefOid')

          # Wait for CI run to appear (up to 5 min)
          for i in $(seq 1 30); do
            RUN_ID=$(gh run list --workflow=ci.yml --commit "$HEAD_SHA" --repo "$REPO" --json databaseId --jq '.[0].databaseId')
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              break
            fi
            echo "Waiting for CI run to startâ€¦ ($i)"
            sleep 10
          done

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "::error::CI run not found after 5 minutes"
            exit 1
          fi

          echo "Watching CI run $RUN_ID"
          gh run watch "$RUN_ID" --repo "$REPO" --exit-status --interval 15

  review:
    name: Review with Claude Code
    needs: gate
    runs-on: ubuntu-latest
    if: |
      !(github.event_name == 'pull_request' && (
        startsWith(github.head_ref, 'renovate/') ||
        startsWith(github.head_ref, 'release-please--')
      ))
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      checks: write
    steps:
      - name: Add reaction
        if: github.event_name == 'issue_comment'
        # v2.1.0 = 608e41b19bc973020ec0e189ebfdae935d7fe0cc
        uses: GrantBirki/comment@608e41b19bc973020ec0e189ebfdae935d7fe0cc
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

      - name: Create check run
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        id: create-check
        with:
          script: |
            let headSha;
            if (context.payload.pull_request) {
              headSha = context.payload.pull_request.head.sha;
            } else {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number,
              });
              headSha = pr.head.sha;
            }
            const { data: check } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Agent Review',
              head_sha: headSha,
              status: 'in_progress',
              started_at: new Date().toISOString(),
            });
            core.setOutput('check-run-id', check.id);
            core.setOutput('head-sha', headSha);

      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ secrets.AWAIT_READY_BOT_APP_ID }}
          private-key: ${{ secrets.AWAIT_READY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha || format('refs/pull/{0}/head', github.event.issue.number) }}
          fetch-depth: 1
          token: ${{ steps.app-token.outputs.token }}

      - name: Review
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1.0.51
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          claude_args: >-
            --model claude-opus-4-6
            --max-turns 20
            --allowedTools "Bash(gh *),Bash(*gh-pr-diff *),Write"
          prompt: |
            Run /review ${{ github.event.pull_request.number || github.event.issue.number }}

      - name: Mark check completed
        if: always() && steps.create-check.outputs.check-run-id
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const conclusion = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: ${{ steps.create-check.outputs.check-run-id }},
              status: 'completed',
              conclusion,
              completed_at: new Date().toISOString(),
            });
